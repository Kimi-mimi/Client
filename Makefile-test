C_VER := -std=c99
FLAGS := -Wall -Werror -pedantic -g3 -gdwarf-2 -DDEBUG -g
CUNIT := -lcunit
BUILD_ROOT_DIR := build
BUILD_ROOT_SHARED := $(BUILD_ROOT_DIR)/shared
BUILD_DIR := $(BUILD_ROOT_DIR)/test

all: create_build_dir shared test

test: test.o string_test.o bytes_test.o
	gcc $(C_VER) $(FLAGS) $(CUNIT) -o $(BUILD_DIR)/test \
$(BUILD_DIR)/test.o \
$(BUILD_DIR)/string_test.o \
$(BUILD_DIR)/bytes_test.o \
$(BUILD_ROOT_SHARED)/string.o \
$(BUILD_ROOT_SHARED)/bytes.o

create_build_dir:
	mkdir -p $(BUILD_DIR)

shared:
	make -f Makefile-shared

test.o: test.c bytes/test/string_test.h
	gcc $(C_VER) $(FLAGS) -c test.c -o $(BUILD_DIR)/test.o

string_test.o: bytes/test/string_test.c bytes/test/string_test.h bytes/string.h
	gcc $(C_VER) $(FLAGS) -c bytes/test/string_test.c -o $(BUILD_DIR)/string_test.o

bytes_test.o: bytes/test/bytes_test.c bytes/test/bytes_test.h bytes/bytes.h
	gcc $(C_VER) $(FLAGS) -c bytes/test/bytes_test.c -o $(BUILD_DIR)/bytes_test.o

clean:
	rm -rf $(BUILD_DIR)